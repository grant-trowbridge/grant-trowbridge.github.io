<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="shortcut icon" href="/images/favicon.png " type="image/png">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Grant Trowbridge's Blog - Proving Grounds SPX: Privilege Escalation</title>
  <meta name="description" content="As I continue to progress through TJ Null&#39;s OSCP PWK V3 list, I wanted to cover a particular machine that had a very unique privilege escalation vulnerab...">
  <link rel="stylesheet" href="/css/main.css ">
  <link rel="alternate" type="application/rss+xml" title="Grant Trowbridge's Blog" href="http://localhost:4000/feed.xml
    " />
</head>

<body>
  <div id="header">
  <div id="header__content">
    <div id="header__info">
      <h1><a href="/">Grant Trowbridge's Blog</a></h1>
      <p>Cybersecurity blog covering security-related topics, CTFs, and signals
</p>
      <img src="/images/avatar.png" alt="avatar">
    </div>
    <ul id="header__nav">
      <li><a href="/" class="">Main</a>
      </li>
      <li><a href="/about" class="">About</a></li>
      <li><a href="/archive" class="">Archive</a></li>
    </ul>
  </div>
</div>
  <div id="content">
    <div id="content__column">
      <div id="single">
  <h2 class="single__title">Proving Grounds SPX: Privilege Escalation</h2>
  <span class="single__date">Jul 2, 2025</span> 
  <article class="single__article">
  <p>As I continue to progress through <a href="https://docs.google.com/spreadsheets/u/1/d/1dwSMIAPIam0PuRBkCiDI88pU3yzrqqHkDtBngUHNCw8/htmlview">TJ Null&#39;s OSCP PWK V3 list</a>, I wanted to cover a particular machine that had a very unique privilege escalation vulnerability. The machine in question is SPX. I&#39;ll skip over initial access for the sake of brevity and limiting spoilers.</p>

<p>Speaking of spoilers, if you plan on completing this machine and don&#39;t want answers given away, DO NOT PROCEED!</p>

<h1>Identifying the Vulnerability</h1>

<p>After gaining your initial foothold, and switching to another user with compromised credentials, your immediate thought should be:</p>

<p><em>what privileges do I have in this new user context?</em> </p>

<p>The answer? A sudo command for the <code>make</code> binary:</p>

<p><img src="/assets/img/PG-SPX-PrivEsc_Sudo-Cmd.png" alt="profiler sudo privileges"></p>

<h2>Research</h2>

<p>Anytime you come across a specific binary with special permissions (<code>sudo</code> in this case), always consult the <a href="https://gtfobins.github.io/gtfobins/make/#sudo">GTFOBins</a> GitHub Pages site.</p>

<p>Initially, it looks like we have an easy win here, but we do not have access to the <code>-s</code> and <code>--eval</code> flags shown in the example code snippet. Remember, the whitelisted command from the <code>sudo -l</code> output was <code>/usr/bin/make install -C /home/profiler/php-spx</code>:</p>

<p><img src="/assets/img/PG-SPX-PrivEsc_Make-GTFOBin.png" alt="GTFOBin Research"></p>

<p>I&#39;ll be honest, I was stumped on this problem for a good hour or so. I decided to thoroughly enumerate the rest of the system. I was convinced I missed something somewhere. Eventually, I realized the <code>sudo</code> permission for this new user was the obvious privilege escalation vulnerability. It was my only direct access to command execution as <em>root</em>.</p>

<h3>Even More Research</h3>

<p>Having used the <code>make</code> utility in the past, I knew it calls on instructions specified in a Makefile. I searched for Makefile exploits/privilege escalation techniques. A few Google searches eventually led me to this <a href="https://medium.com/@adamforsythebartlett/makefile-privilege-escalation-oscp-62ea2c666d23">Medium</a> article, written by one Adam Bartlett. He explains that <code>make</code> can be used to execute bash commands in the same directory that the <code>Makefile</code> resides in. Here is the malicious syntax for bash execution.</p>

<p><img src="/assets/img/PG-SPX-PrivEsc_Make-Medium-Blog.png" alt="Medium Article Example"></p>

<h1>Crafting the Makefile</h1>

<p>Now it&#39;s time to match the example to our target system. I always like to start by making a backup of a file I&#39;m modifying. It&#39;s not a requirement by any means, but it&#39;s good practice.</p>
<div class="highlight"><pre><code class="language-" data-lang="">profiler@spx:/var/www$ cd ~/php-spx/
profiler@spx:~/php-spx$ cp Makefile ./Makefile.bak
</code></pre></div>
<p>There&#39;s many different bash techniques that can be used to spawn a root shell. I chose to create a malicous copy of bash with an SUID bit. This allows any user to execute this bash copy with a <code>-p</code> flag, which tells bash to not reset the effective user ID with my real user ID. In short, bash will run with the file owner&#39;s permissions (root).</p>

<p><img src="/assets/img/PG-SPX-PrivEsc_New-Makefile.png" alt="Malicious Makefile"></p>

<h1>Escalating Privileges</h1>

<p>With the malicious Makefile in place, it&#39;s simply a matter of executing profiler&#39;s allowed <code>sudo</code> command.</p>

<p><img src="/assets/img/PG-SPX-PrivEsc_Sudo-Make-Exploit.png" alt="Sudo Make Exploit"></p>

<p>Now I&#39;ll execute the new <code>/tmp/evil</code> bash copy, ensuring the <code>-p</code> flag is provided as an argument to spawn a root shell!</p>

<p><img src="/assets/img/PG-SPX-PrivEsc_Bash-Privilege-Escalation.png" alt="Evil Bash Copy"></p>

<h1>Lessons Learned</h1>

<p>The very specific <code>sudo</code> command is a great starting point, but the true vulnerability lies in the specified directory, <code>/home/profiler/php-spx</code>, where the standard user <code>profiler</code> has <em>write</em> access to the directory, and as a result, to the <em>Makefile</em> itself. If the specified directory prevented the <code>profiler</code> user write access, or was instead owned by <code>root</code>, there would be no opportunity to escalate privileges. In short, the devil is always in the details, and file permissions matter!</p>

<p><img src="/assets/img/PG-SPX-PrivEsc_Lessons-Learned.png" alt="Lessons Learned"></p>

  </article>
</div>
    </div>
  </div>
    <div id="footer">
  Powered by <a href="http://jekyllrb.com" target="_blank">Jekyll</a> Â· <a href="https://github.com/ifedyukin/Mekyll">Mekyll</a> theme <br>
</div>

</body>
</html>