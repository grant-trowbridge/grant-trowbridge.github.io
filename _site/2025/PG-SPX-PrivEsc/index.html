<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="shortcut icon" href="/images/favicon.png " type="image/png">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Grant Trowbridge's Blog - Proving Grounds SPX: Privilege Escalation</title>
  <meta name="description" content="As I progress through TJ Null&#39;s OSCP PWK V3 list, I wanted to cover a particular machine that had a very unique privilege escalation vulnerability. The m...">
  <link rel="stylesheet" href="/css/main.css ">
  <link rel="alternate" type="application/rss+xml" title="Grant Trowbridge's Blog" href="http://localhost:4000/feed.xml
    " />
</head>

<body>
  <div id="header">
  <div id="header__content">
    <div id="header__info">
      <h1><a href="/">Grant Trowbridge's Blog</a></h1>
      <p>A Cyber Security blog covering security-related topics, CTFs, and signals
</p>
      <img src="/images/avatar.png" alt="avatar">
    </div>
    <ul id="header__nav">
      <li><a href="/" class="">Main</a>
      </li>
      <li><a href="/about" class="">whoami</a></li>
      <li><a href="/archive" class="">Archive</a></li>
    </ul>
  </div>
</div>
  <div id="content">
    <div id="content__column">
      <div id="single">
  <h2 class="single__title">Proving Grounds SPX: Privilege Escalation</h2>
  <span class="single__date">Jul 7, 2025</span> 
  <article class="single__article">
  <p>As I progress through <a href="https://docs.google.com/spreadsheets/u/1/d/1dwSMIAPIam0PuRBkCiDI88pU3yzrqqHkDtBngUHNCw8/htmlview">TJ Null&#39;s OSCP PWK V3 list</a>, I wanted to cover a particular machine that had a very unique privilege escalation vulnerability. The machine in question is SPX. I&#39;ll skip over initial access for the sake of brevity and limiting spoilers. Speaking of spoilers, you&#39;ve been warned!</p>

<h1>Identifying the Vulnerability</h1>

<p>Once I had my initial footfold into the machine, and gained access to a local user account, my immediate thought was:</p>

<p><em>what privileges do I have in this new user context?</em> </p>

<p>After some manual enumeration, I eventually found the answer. A sudo command for the <code>make</code> binary:</p>

<p><img src="/assets/img/PG-SPX-PrivEsc_Sudo-Cmd.png" alt="profiler sudo privileges"></p>

<h2>Research</h2>

<p>Anytime I come across a specific Unix binary with special permissions (<code>sudo</code> in this case), I always consult the <a href="https://gtfobins.github.io/gtfobins/make/#sudo">GTFOBins</a> GitHub Pages site.</p>

<p>Initially, it looked like I had an easy win here, but I do not have access to the <code>-s</code> and <code>--eval</code> flags shown in the example GTFOBins code snippet. The target&#39;s whitelisted command from the <code>sudo -l</code> output was <code>/usr/bin/make install -C /home/profiler/php-spx</code>:</p>

<p><img src="/assets/img/PG-SPX-PrivEsc_Make-GTFOBin.png" alt="GTFOBin Research"></p>

<p>I&#39;ll be honest, I was stumped on this problem for a good hour or so. I decided to thoroughly enumerate the rest of the system. I was convinced I missed something somewhere. Eventually, I realized the <code>sudo</code> permission for this user was the obvious privilege escalation vulnerability. It was my only access to command execution as <em>root</em> on the target.</p>

<h3>Even More Research</h3>

<p>Having used the <code>make</code> utility in the past, I knew it called on instructions specified in a <code>Makefile</code>. I searched for <code>Makefile</code> exploits/privilege escalation techniques. Googling this topic eventually led me to this <a href="https://medium.com/@adamforsythebartlett/makefile-privilege-escalation-oscp-62ea2c666d23">Medium</a> article, written by one Adam Bartlett. He explains that <code>make</code> can be used to execute bash commands when the target directory is specified using the <code>-C</code> flag.</p>

<blockquote>
<p>The “make” command looks for a file called “Makefile”. If you’re looking for code execution, make sure you’re running “make” in the location where “Makefile” is executed, or specify the directory using the -C flag.</p>
</blockquote>

<p>Here is the malicious syntax for bash execution provided in the article.</p>

<p><img src="/assets/img/PG-SPX-PrivEsc_Make-Medium-Blog.png" alt="Medium Article Example"></p>

<h1>Crafting the Makefile</h1>

<p>Now it&#39;s time to match the example to the target system. I always like to start by making a backup of a file I&#39;m modifying. It&#39;s not a requirement by any means, but it&#39;s a good habit to have.</p>
<div class="highlight"><pre><code class="language-" data-lang="">profiler@spx:/var/www/html$ cd ~/php-spx/
profiler@spx:~/php-spx$ cp Makefile ./Makefile.bak
</code></pre></div>
<p>There&#39;s many different bash techniques that can be used to spawn a <em>root</em> shell in this scenario. I chose to create a malicous copy of bash with an SUID bit. When a standard user executes this bash copy with a <code>-p</code> flag, it tells bash to not reset the effective user ID with my real user ID. In short, bash will run with the file owner&#39;s permissions (<em>root</em>).</p>

<p><img src="/assets/img/PG-SPX-PrivEsc_New-Makefile.png" alt="Malicious Makefile"></p>

<h1>Escalating Privileges</h1>

<p>With the malicious <code>Makefile</code> in place, it&#39;s simply a matter of executing the allowed <code>sudo</code> command.</p>

<p><img src="/assets/img/PG-SPX-PrivEsc_Sudo-Make-Exploit.png" alt="Sudo Make Exploit"></p>

<p>Now I&#39;ll execute the new <code>/tmp/evil</code> bash binary, ensuring the <code>-p</code> flag is provided to spawn a <em>root</em> shell!</p>

<p><img src="/assets/img/PG-SPX-PrivEsc_Bash-Privilege-Escalation.png" alt="Evil Bash Binary"></p>

<h1>Lessons Learned</h1>

<p>The very specific <code>sudo</code> command was a great starting point for securing the system, but the true vulnerability lies in the specified directory&#39;s permissions, <code>/home/profiler/php-spx</code>. The standard user <em>profiler</em> had <strong>write</strong> access to the directory, and as a result, write access to the <code>Makefile</code> itself. If the directory prevented the <em>profiler</em> user from having write access, there would be no opportunity to escalate privileges.</p>

<p>This machine was an excellent reminder that the devil is always in the details, and file permissions matter!</p>

<p><img src="/assets/img/PG-SPX-PrivEsc_Lessons-Learned.png" alt="Lessons Learned"></p>

  </article>
</div>
    </div>
  </div>
    <div id="footer">
  Powered by <a href="http://jekyllrb.com" target="_blank">Jekyll</a> · <a href="https://github.com/ifedyukin/Mekyll">Mekyll</a> theme <br>
</div>

</body>
</html>